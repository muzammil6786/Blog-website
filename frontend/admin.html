<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 0 16px;
            background: #f9f9f9;
        }

        h2 {
            color: #007bff;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        textarea,
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        button {
            padding: 10px 16px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .top-right {
            align-self: flex-end;
            background: #dc3545;
        }

        #admin-blogs {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .blog {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .blog img {
            max-width: 100%;
            border-radius: 6px;
            display: block;
            margin: 8px 0;
        }

        .actions {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .actions button.edit {
            background: #28a745;
        }

        #pagination {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        #pagination button {
            padding: 6px 12px;
            background: #eee;
            color: black;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #pagination button.active {
            background: #007bff;
            color: white;
        }

        @media (min-width: 600px) {
            #admin-blogs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 900px) {
            #admin-blogs {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <h2>Admin Dashboard</h2>

    <form id="blog-form" enctype="multipart/form-data">
        <input type="text" name="title" placeholder="Blog Title" required />
        <textarea name="content" placeholder="Markdown Content" required></textarea>
        <input type="file" name="image" />
        <div style="display:flex; flex-wrap:wrap; gap:10px;">
            <button type="submit">Post Blog</button>
            <button type="button" class="top-right" onclick="logout()">Logout</button>
        </div>
    </form>

    <h3>All Blogs</h3>
    <div id="admin-blogs"></div>
    <div id="pagination"></div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const BASE_URL = 'https://blog-website-dva5.onrender.com';
        const token = localStorage.getItem('token'); // Assume admin login stores token

        const blogForm = document.getElementById('blog-form');
        const blogList = document.getElementById('admin-blogs');
        const pagination = document.getElementById('pagination');

        const urlParams = new URLSearchParams(window.location.search);
        const page = parseInt(urlParams.get('page')) || 1;
        const limit = 5;

        function fetchBlogs() {
            fetch(`${BASE_URL}/api/blogs?page=${page}&limit=${limit}`, {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            })
                .then(res => res.json())
                .then(data => {
                    blogList.innerHTML = '';
                    data.blogs.forEach(blog => {
                        const div = document.createElement('div');
                        div.className = 'blog';
                        div.innerHTML = `
              <h4>${blog.title}</h4>
              ${blog.imageUrl ? `<img src="${BASE_URL}${blog.imageUrl}" />` : ''}
              <div>${marked.parse(blog.content.slice(0, 100))}...</div>
              <div class="actions">
                <button onclick="deleteBlog('${blog._id}')">üóë Delete</button>
                <button class="edit" onclick="editBlog('${blog._id}')">‚úè Edit</button>
              </div>
            `;
                        blogList.appendChild(div);
                    });

                    const totalPages = data.totalPages;
                    pagination.innerHTML = '';
                    if (totalPages > 1) {
                        if (page > 1) {
                            const prev = document.createElement('button');
                            prev.textContent = '¬´ Prev';
                            prev.onclick = () => window.location.href = `admin.html?page=${page - 1}`;
                            pagination.appendChild(prev);
                        }

                        for (let i = 1; i <= totalPages; i++) {
                            const btn = document.createElement('button');
                            btn.textContent = i;
                            if (i === page) btn.classList.add('active');
                            btn.onclick = () => window.location.href = `admin.html?page=${i}`;
                            pagination.appendChild(btn);
                        }

                        if (page < totalPages) {
                            const next = document.createElement('button');
                            next.textContent = 'Next ¬ª';
                            next.onclick = () => window.location.href = `admin.html?page=${page + 1}`;
                            pagination.appendChild(next);
                        }
                    }
                });
        }

        fetchBlogs();

        blogForm.onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(blogForm);

            await fetch(`${BASE_URL}/api/blogs`, {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${token}`
                },
                body: formData
            });

            blogForm.reset();
            fetchBlogs();
        };

        function deleteBlog(id) {
            if (confirm("Are you sure you want to delete this blog?")) {
                fetch(`${BASE_URL}/api/blogs/${id}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                })
                    .then(response => response.json())
                    .then(() => {
                        alert("Blog deleted successfully ‚úÖ");
                        fetchBlogs();
                    })
                    .catch(err => alert("Error: " + err.message));
            }
        }

        window.editBlog = async function (id) {
            const res = await fetch(`${BASE_URL}/api/blogs/${id}`);
            const blog = await res.json();

            document.querySelector('input[name="title"]').value = blog.title;
            document.querySelector('textarea[name="content"]').value = blog.content;

            document.getElementById('blog-form').onsubmit = async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                await fetch(`${BASE_URL}/api/blogs/${id}`, {
                    method: 'PATCH',
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData
                });

                alert("Blog updated!");
                form.reset();
                location.reload();
            };
        };

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>